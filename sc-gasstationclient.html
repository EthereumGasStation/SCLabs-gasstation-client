<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">

<script src="./utility.js"></script>
<!-- <script src="keythereum.js"></script> -->
<script src="../web3/dist/web3.min.js"></script>
<script src="../browser-builds/dist/ethereumjs-tx.js"></script>

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<!-- <link rel="import" href="./shared-styles.html"> -->

<dom-module id="sc-gasstationclient">
  <template>
  <style include="shared-styles">
  :host {
    display: block;
    background-color: var(--sc-grey1);
    padding: 40px;
  }
  .balances {
    @apply --layout-horizontal;
    @apply --layout-center-justified;
    @apply(--layout-center);
    margin-bottom: 40px;
  }
  .header {
    width: 100%;
    @apply --layout-vertical;
    @apply --layout-end;
  }
  .vertical {
    @apply --layout-vertical;
    @apply --layout-center-center;
    margin-bottom: 40px;
  }
  .balance_single {
    background-color: var(--sc-yellow);
    @apply --layout-vertical;
    @apply --layout-center-center;
    width: 100px;
    overflow: hidden;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    min-width: 120px;
    min-height: 120px;
  }
  .address {
    text-align: center;
    font-weight: bold;
    text-overflow: ellipsis;
    overflow: hidden;
    height: 1.2em;
    white-space: nowrap;
  }
  .spacer {
    width: 30px;
    text-align: center;
    color: var(--sc-lightgray);
    font-size: 26px;
  }
  .close {
    width: 20px;
    height: 20px;
    background: url('./images/swarm-city-sprite.png') -60px -84px;
    cursor: pointer;
  }
  .big {
    width: 80px;
    height: 80px;
    min-width: 80px;
    min-height: 80px;
    overflow: hidden;
    border-radius: 50%;
    text-align: center;
  }
  .big img {
    width: 82px;
    height: 82px;
    min-width: 82px;
    min-height: 82px;
    margin: -1px 0px 0px -1px;
    text-align: center;
  }
  .container {
    margin-top: 20px;
    @apply --layout-vertical;
    @apply --layout-center-center;
  }
  h1 {
    @apply --body-default-wide;
    text-align: center;
  }
  p {
    @apply --body-default;
    text-align: center;
  }

  div {
    @apply --body-default;
    text-align: center;
  }

  .balance {
    @apply --body-default-wide;
    font-size: 26px;
    margin-bottom: 5px;
  }

  .btn {
    @apply --small-light;
    text-align: center;
    width: 275px;
    height: 72px;
    line-height: 30px;
    text-align: center;
    display: block;
    border: none;
    font-size: 18px;
    cursor: pointer;
    box-sizing: border-box;
    padding: 20px;
    color: var(--sc-white);
    background-color: var(--sc-blue);
    box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -o-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -moz-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -webkit-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    margin: 10px auto 0;
    font-weight: bold;
    text-align: center;
  }


  .gasbtn {
    @apply --small-light;
    text-align: center;
    width: 275px;
    height: 72px;
    line-height: 30px;
    text-align: center;
    display: block;
    border: none;
    font-size: 18px;
    cursor: pointer;
    box-sizing: border-box;
    padding: 20px;
    color: var(--sc-blue);
    background-color: var(--sc-white);
    box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -o-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -moz-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -webkit-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    margin: 10px auto 0;
    font-weight: bold;
    text-align: center;
  }

  #selector > .iron-selected {
    background-color: var(--sc-blue);
    color: var(--sc-white);
  }



  </style>
  <template is="dom-if" if="{{gasstationready}}">

    <div class="header">
      <div class="close" on-click="_close"></div>
    </div>
    <div class="container">
      <div class="vertical">
        <div class="big">
          <img src="../images/gasstation.png" />
        </div>
        <h1>Gas Station</h1>
      </div>
      <iron-pages selected="{{selectedpage}}">
        <!-- page 0 -->
        <div>
          <div>{{project}} is built on top of the Ethereum blockchain. For every transaction, a small fee called "gas" is paid to the miners who make sure the blockchain is running perfectly. Gas makes Swarm City transactions go.</div>
          <div>&nbsp;</div>
          <div>Balances for current address: </div>
          <div class="address">[[address]]</div>
          <p>&nbsp;</p>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[ethbalance]]</div><div>ETH</div></div>
            <div class="spacer"></div>
            <div class="balance_single"><div class="balance">[[tokenbalance]]</div><div>{{short}}</div></div>
          </div>
          <div class="btn" on-click="toStation">Get more gas</div>
        </div>

        <!-- page 1 -->
        <div>
          <p>How many deals would you like to do?</p>
          <p>&nbsp;</p>
          <div>
            <iron-selector
            id="selector"
            attr-for-selected="name"
            on-iron-select="doSomething"
            selected-item="{{selecteditem}}">
              <div class="gasbtn" name="1">1</div>
              <div class="gasbtn" name="10">10</div>
              <div class="gasbtn" name="20">20</div>
              <div class="gasbtn" name="50">50</div>
            </iron-selector>
          </div>
        <div class="btn" on-click="toPersonalizedoffer">Continue ></div>

        <!-- <h1>Our best offer:</h1>
        <div><pre>[[getPriceResult_pre]]</pre></div> -->
        <!-- <div on-tap="fillUp"><b>Fill her up</b></div> -->
      </div>

      <!-- page personalizedoffer -->
      <div>
        <div>
          <p>This offer is personal and limited to the next 5 blocks.</p>
          <p>&nbsp;</p>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[nrofdeals]]</div><div>DEALS</div></div>
            <div class="spacer">=</div>
            <div class="balance_single"><div class="balance">[[swtamount]]</div><div>{{short}}</div></div>
          </div>

        </div>
        <p>&nbsp;</p>

        <div class="btn" on-click="fillUp">Start filling</div>

      </div>

      <!-- page 3 -->
      <div>
        <p>Filling now</p>
        <h1>{{fillingbalance}} / {{swtamount}} SWT</h1>
        <div><pre>[[fillUpResult_pre]]</pre></div>
        <p>&nbsp;</p>
        <div id="balancesview" hidden>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[ethbalance]]</div><div>ETH</div></div>
            <div class="spacer"></div>
            <div class="balance_single"><div class="balance">[[tokenbalance]]</div><div>{{short}}</div></div>
          </div>
          <div class="btn" on-click="toEnd">Continue</div>
        </div>
      </div>

      <!-- page 4 -->
      <div>
        <h1>Set up automatic refills</h1>
        <p>If you want, your gas balance can be automatically refilled when needed.</p>
        <p>&nbsp;</p>
        <input type="checkbox" name="autofill" value=""> Automatically fill up my gas tank
        <p>&nbsp;</p>
        <div class="btn" on-click="exitStation">Exit Gas Station</div>
      </div>
    </iron-pages>
  </div>

</template>

<template is="dom-if" if="{{!gasstationready}}">
  <div class="container">
    <div class="vertical">
      <div class="big">
        <img src="/gs-client/images/gasstation.png" />
      </div>
      <h1>Gas Station</h1>
      <p>&nbsp;</p>
      <p><b>Could not find a valid wallet.</b></p>
      <p>Gas Station could not find a valid wallet. Follow the instructions to set up your wallet to see this amazing component in action.</p>
      <p>&nbsp;</p>
      <div class="btn" on-click="">Retry</div>

    </div>
  </div>
</template>
</template>

<script>
/**
* `sc-gasstationclient`
*
*
* @customElement
* @polymer
* @demo demo/index.html
*/
class ScGasstationclient extends Polymer.Element {
  static get is() { return 'sc-gasstationclient'; }
  static get properties() {
    return {
      utility: {
        type: Object,
        value: function(){
          return window.utility();
        }
      },
      keythereum: {
        type: Object,
        value: function(){
          return window.keythereum;
        }
      },
      gasstationready: {
        type: Boolean,
        value: true
      },
      project: {
        type: String,
        value: 'Swarm City'
      },
      short: {
        type: String,
        value: 'SWT'
      },
      selectedpage: {
        type: Number,
        value: 0
      },
      ethbalance: {
        type: Number,
        value: 0
      },
      tokenbalance: {
        type: Number,
        value: 0
      },
      currentprice: {
        type: Number,
        value: 0
      },
      erc20: {
        type: String
      },
      privatekey: {
        type: String
      },
      fillingbalance: {
        type: Number,
        value: 0
      },
      swtamount: {
        type: Number,
        value: 0.00
      },
      gasstation: {
        type: Object,
        value: {}
      },
      minimetoken: {
        type: Object,
        value: {}
      },
      apiendpoint: {
        type: String,
      },
      ethnode: {
        type: String
      }
    };
  }

  toStation() {
    console.log('to station');
    this.selectedpage = 1;
  }

  toPersonalizedoffer() {
    this.swtamount = this.pricefor1 * this.nrofdeals * 1e18;
    this.swtamount = Math.floor(this.swtamount.toFixed(4));
    this.selectedpage = 2;
  }

  toEnd() {
    this.selectedpage = 4;
  }

  exitStation() {
    this.selectedpage = 0;
  }

  doSomething() {
    console.log('something was selected, ', this.selecteditem);
    this.nrofdeals = this.selecteditem.innerHTML;
  }

  _close() {
    alert('In Swarm City, this close icon would take you back');
  }

  getPrice() {
    //debugger;
    return new Promise((resolve, reject) => {
      // Load the translations.json file
      const xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      xobj.open('GET', this.apiendpoint + '/price?from=' + this.address+'&tokenaddress=' + this.erc20, true);
      xobj.onreadystatechange = () => {
        if (xobj.readyState == 4 && xobj.status == '200') {
          // Parse the response
          const json = JSON.parse(xobj.responseText);
          this.getPriceResult = json;
          this.getPriceResult_pre = JSON.stringify(json, null, 2);
          // this.currentprice = wei for 1 swt
          this.currentprice = this.getPriceResult.price;

          this.weineeded = 200000 * 2 * 1e9;
          this.swtneeded = this.weineeded / this.currentprice;
          this.pricefor1 = this.swtneeded.toFixed(4);
          this.pricefor10 = this.pricefor1 * 10;
          this.pricefor20 = this.pricefor1 * 20;
          this.pricefor50 = this.pricefor1 * 50;
          this.pricefor100 = this.pricefor1 * 100;

          this.showfill = true;
          resolve();
        }
      };
      xobj.send(null);
    });
  }

  showbalances() {
    var self = this;
    //debugger;
    // animation to open up the balances view and check the current balance.
    setTimeout(function() {
      //your code to be executed after 1 second
      self.shadowRoot.querySelector('#balancesview').hidden = false;
    }, 1000);
  }

  fillUp() {

    this.selectedpage = 3;
    var audio = new Audio('../images/done.m4a');
    //this.swtamount = 1.00;
    var amounttoget = this.swtamount;

    var self = this;
    var now = 0;

    var x = setInterval(function() {
      now = now+0.0001;
      //audio.play();
      self.fillingbalance = now.toFixed(4);

      // If the count down is finished, write some text
      if (now >= amounttoget) {
        //audio.play();
        clearInterval(x);
        self.fillingbalance = self.swtamount;
        self.showbalances();
      }
    }, 5);



    var minime = this.web3.eth.contract(this.minimetoken.abi);
    var minimeInstance = minime.at(this.getPriceResult.token_address);

    // minimeInstance.balanceOf(this.address, function(err, res) {
    //   console.log('SWT balance is', res.toFormat(2));
    //   self.tokenbalance = res;
    // });

    console.log('sending approval for ', this.tokenamount, 'to', this.getPriceResult.to);

    var txData = minimeInstance.approve.getData(this.getPriceResult.to, this.tokenamount, function(a, b) {
      //debugger;
    });
  
    minimeInstance.approve.estimateGas(this.getPriceResult.from, this.getPriceResult.to, this.tokenamount, {
      from: self.address
    }, function(err, res) {
      if (err) {
        console.log(err);
      }
      var gasRequired = res;

      // get nonce
      self.web3.eth.getTransactionCount(self.address, function(err, nonce) {

        if (!nonce) {
          console.log('nonce of address', self.address, 'is undefined...');
          nonce = 0;
        }

        console.log('nonce of address', self.address, 'is', nonce);

        var txParams = {
          nonce: nonce++,
          gasPrice: self.gasPrice,
          gasLimit: gasRequired,
          to: self.getPriceResult.token_address,
          from: self.address,
          data: txData,
          chainId: 1
        }

        var tx = new EthJS.Tx(txParams);
        tx.sign(self.privatekey_buffer);
        var serializedTx = tx.serialize(); //.toString('hex');

        var tx1 = '0x' + serializedTx.toString('hex');

        console.log('tx1');
        console.log(txParams);
        console.log(tx1);

        var gasstation = self.web3.eth.contract(self.gasstation.abi);
        self.gasstationInstance = gasstation.at(self.getPriceResult.to);

        txData = self.gasstationInstance.fillup.getData(
          self.getPriceResult.token_address,
          self.getPriceResult.price,
          self.getPriceResult.valid_until,
          self.getPriceResult.random,
          self.getPriceResult.upfront,
          1,
          self.getPriceResult.sig.v,
          self.getPriceResult.sig.r,
          self.getPriceResult.sig.s);

        txParams = {
          nonce: nonce++,
          gasPrice: self.gasPrice,
          gasLimit: 1000000,
          from: self.address,
          to: self.getPriceResult.to,
          data: txData,
          chainId: 1
        }

        var tx2 = new EthJS.Tx(txParams);
        tx2.sign(self.privatekey_buffer);
        serializedTx = tx2.serialize();

        var tx2 = '0x' + serializedTx.toString('hex');

        console.log('tx2');
        console.log(txParams);
        console.log(tx2);

        var res = {
          tx1: tx1,
          tx2: tx2
        };

        // send the TX to the backend
        var xhr = new XMLHttpRequest();
        xhr.open("POST", self.apiendpoint + '/fillup', true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
            console.log(xhr);
          }
        }
        xhr.send(JSON.stringify(res));


    });
        });
    

  }

  gettankbalance() {
    var minime = this.web3.eth.contract(this.minimetoken.abi);
    var minimeInstance = minime.at(this.erc20);
    var self = this;
    minimeInstance.balanceOf(this.getPriceResult.to, function(err, res) {
      if (!err) {
        console.log('GT balance at '+self.getPriceResult.to+'is', res.toFormat(2));
        //self.tokenbalance = res;
      }
    });
  }

  ready() {
    super.ready();

    var self = this;

    this.web3 = new Web3(new Web3.providers.HttpProvider(this.ethnode));

    this.tokenamount = 1;
    this.gasPrice = 2 * 1e9; // 2 GWei

    this.address = EthJS.Util.addHexPrefix(EthJS.Util.privateToAddress(EthJS.Util.addHexPrefix(this.privatekey)).toString('hex'));

    this.privatekey_buffer = new EthJS.Buffer.Buffer(this.privatekey, "hex");

    // Get the minime and token abi
    var minimetokenabi;
    var gassstationabi;

  self.getPrice().then(function(){

    self.erc20 = "0xd2444365f33079be7160b7052cf544594c137e3d";

    // Get abis
    return new Promise((resolve, reject) => {
      // Load the translations.json file
      const xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      xobj.open('GET', self.apiendpoint + '/abi', true);
      xobj.onreadystatechange = () => {
        if (xobj.readyState == 4 && xobj.status == '200') {
          // Parse the response
          const json = JSON.parse(xobj.responseText);
          console.log(json);
          //return json;
          self.minimetoken.abi = json.erc20;
          self.gasstation.abi = json.gasstation;
          var minime = self.web3.eth.contract(json.erc20);
          var minimeInstance = minime.at(self.erc20);
          minimeInstance.balanceOf(self.address, function(err, res) {
            if (!err) {
              console.log('SWT balance of client\'s account (',self.address,') is', res.toFormat(2));
              var tokenshit = res / 1e18;
              self.tokenbalance = tokenshit.toFixed(2);

              self.web3.eth.getBalance(self.address, function(err, res) {
                console.log('ETH balance of client\'s account (',self.address,') is', res.toString(10));
                self.ethbalance = (res/ 1e18).toFixed(2);
              });

            

            }
          });
          //debugger;
          resolve();
        }
      };
      xobj.send(null);
    });

  });

    // End getting minime and token abi

  }
}

window.customElements.define(ScGasstationclient.is, ScGasstationclient);
</script>
</dom-module>
