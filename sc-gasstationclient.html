<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">

<script src="./utility.js"></script>
<!-- <script src="keythereum.js"></script> -->
<script src="../web3/dist/web3.min.js"></script>
<script src="/webpack.min.js"></script>

<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="./shared-styles.html">

<dom-module id="sc-gasstationclient">
  <template>
  <style include="shared-styles">
  :host {
    display: block;
    background-color: var(--sc-grey1);
    padding: 40px;
  }
  .balances {
    @apply --layout-horizontal;
    @apply --layout-center-justified;
    @apply(--layout-center);
    margin-bottom: 40px;
  }
  .header {
    width: 100%;
    @apply --layout-vertical;
    @apply --layout-end;
  }
  .vertical {
    @apply --layout-vertical;
    @apply --layout-center-center;
    margin-bottom: 40px;
  }
  .balance_single {
    background-color: var(--sc-yellow);
    @apply --layout-vertical;
    @apply --layout-center-center;
    width: 100px;
    overflow: hidden;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    min-width: 120px;
    min-height: 120px;
  }
  .address {
    text-align: center;
    font-weight: bold;
    text-overflow: ellipsis;
    overflow: hidden;
    height: 1.2em;
    white-space: nowrap;
  }
  .spacer {
    width: 30px;
    text-align: center;
    color: var(--sc-lightgray);
    font-size: 26px;
  }
  .close {
    width: 20px;
    height: 20px;
    background: url('./images/swarm-city-sprite.png') -60px -84px;
    cursor: pointer;
  }
  .refresh {
        width: 54px;
        height: 54px;
        background: url('./images/SwarmCity-Sprite-normal.png') -162px -54px;
        cursor: pointer;
  }
  .big {
    width: 80px;
    height: 80px;
    min-width: 80px;
    min-height: 80px;
    overflow: hidden;
    border-radius: 50%;
    text-align: center;
  }
  .big img {
    width: 82px;
    height: 82px;
    min-width: 82px;
    min-height: 82px;
    margin: -1px 0px 0px -1px;
    text-align: center;
  }
  .container {
    margin-top: 20px;
    @apply --layout-vertical;
    @apply --layout-center-center;
  }
  h1 {
    @apply --body-default-wide;
    text-align: center;
  }
  p {
    @apply --body-default;
    text-align: center;
  }
  div {
    @apply --body-default;
    text-align: center;
  }
  .balance {
    @apply --body-default-wide;
    font-size: 26px;
    margin-bottom: 5px;
  }
  .btn {
    @apply --small-light;
    text-align: center;
    width: 275px;
    height: 72px;
    line-height: 30px;
    text-align: center;
    display: block;
    border: none;
    font-size: 18px;
    cursor: pointer;
    box-sizing: border-box;
    padding: 20px;
    color: var(--sc-white);
    background-color: var(--sc-blue);
    box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -o-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -moz-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -webkit-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    margin: 10px auto 0;
    font-weight: bold;
    text-align: center;
  }
  .gasbtn {
    @apply --small-light;
    text-align: center;
    width: 275px;
    height: 72px;
    line-height: 30px;
    text-align: center;
    display: block;
    border: none;
    font-size: 18px;
    cursor: pointer;
    box-sizing: border-box;
    padding: 20px;
    color: var(--sc-blue);
    background-color: var(--sc-white);
    box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -o-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -moz-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    -webkit-box-shadow: 0px 1px 2px -1px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    margin: 10px auto 0;
    font-weight: bold;
    text-align: center;
  }
  .forswt {
    font-weight: lighter;
  }
  #selector > .iron-selected {
    background-color: var(--sc-blue);
    color: var(--sc-white);
  }
  </style>
  <template is="dom-if" if="{{gasstationready}}">

    <div class="header">
      <div class="close" on-click="_close"></div>
    </div>
    <div class="container">
      <div class="vertical">
        <div class="big">
          <img src="/images/logo.png" />
        </div>
        <h1>You are out of gas.</h1>
      </div>
      <iron-pages selected="{{selectedpage}}">
        <!-- page 0 -->
        <div>
          <div>{{project}} is built on top of the Ethereum blockchain. For every transaction, a small fee called "gas" is paid to the miners who make sure the blockchain is running perfectly. Gas makes Swarm City transactions go.</div>
          <div>&nbsp;</div>
          <div>Balances for current address: </div>
          <div class="address">[[address]]</div>
          <p>&nbsp;</p>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[tokenbalance]]</div><div>{{short}}</div></div>
            <div class="spacer"></div>
            <div class="balance_single"><div class="balance">[[ethbalance]]</div><div>ETH</div></div>
          </div>
          <div class="balances">
            <div class="refresh" on-click="getBalances"></div>
          </div>
          <div class="btn" on-click="toStation">Get more gas</div>
        </div>

        <!-- page 1 -->
        <div>
          <p>Our best offer:</p>
          <p>&nbsp;</p>
          <div>
            DISPLAY OFFER HERE
          </div>
        <div class="btn" on-click="toPersonalizedoffer">Continue ></div>

        <div><pre>[[getPriceResult_pre]]</pre></div>
        <!-- <div on-tap="fillUp"><b>Fill her up</b></div> -->
      </div>

      <!-- page personalizedoffer -->
      <div>
        <div>
          <p>This offer is only valid for your public key, and limited to the next 5 blocks.</p>
          <p>&nbsp;</p>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[formatbalance(swtamount)]]</div><div>{{short}}</div></div>
            <div class="spacer">=</div>
            <!-- <div class="balance_single"><div class="balance">[[nrofdeals]]</div><div>DEALS</div></div>
            <div class="spacer">=</div> -->
            <div class="balance_single"><div class="balance">[[weiamount]]</div><div>ETH</div></div>
          </div>

        </div>
        <p>&nbsp;</p>

        <div class="btn" on-click="fillUp">Fill it up!</div>

      </div>

      <!-- page 3 -->
      <div>
        <p>Filling now</p>
        <h1>{{fillingbalance}} / {{swtdisplay}} SWT</h1>
        <div><pre>[[fillUpResult_pre]]</pre></div>
        <div id="balancesview" hidden>
          <p>&nbsp;</p>
          <div class="balances">
            <div class="balance_single"><div class="balance">[[ethbalance]]</div><div>ETH</div></div>
            <div class="spacer"></div>
            <div class="balance_single"><div class="balance">[[tokenbalance]]</div><div>{{short}}</div></div>
          </div>
          <div class="balances">
            <div class="refresh" on-click="getBalances"></div>
          </div>
          <p>&nbsp;</p>
          <div class="btn" on-click="toEnd">Continue</div>
        </div>
      </div>

      <!-- page 4 -->
      <div>
        <h1>Set up automatic refills</h1>
        <p>Your gas balance can be automatically refilled when needed.</p>
        <p>&nbsp;</p>
        <input type="checkbox" name="autofill" value=""> Automatically fill up my gas tank
        <p>&nbsp;</p>
        <div class="btn" on-click="_close">Exit Gas Station</div>
      </div>

      <!-- Page 5: found private key, doing stuff with it. -->
      <div>
        <h1>Found a keypair.</h1>
        <p>Trying to get your account working now...</p>
        <p>&nbsp;</p>
        <p>&nbsp;</p>
        <div class="btn" on-click="makeReady">Retry</div>
      </div>
    </iron-pages>
  </div>

</template>

<template is="dom-if" if="{{!gasstationready}}">
  <div class="container">
    <div class="vertical">
      <div class="big">
        <img src="/images/logo.png" />
      </div>
      <h1>Gas Station</h1>
      <p>&nbsp;</p>
      <p><b>Could not find a valid wallet.</b></p>
      <p>Gas Station could not find a valid wallet.<br> Follow the instructions to set up your wallet to see this amazing component in action.</p>
      <p>&nbsp;</p>
      <div class="refresh" on-click="makeReady"></div>
    </div>
  </div>
</template>
</template>

<script>
/**
* `sc-gasstationclient`
*
*
* @customElement
* @polymer
* @demo demo/index.html
*/
class ScGasstationclient extends Polymer.Element {
  static get is() { return 'sc-gasstationclient'; }
  static get properties() {
    return {
      utility: {
        type: Object,
        value: function(){
          return window.utility();
        }
      },
      keythereum: {
        type: Object,
        value: function(){
          return window.keythereum;
        }
      },
      gasstationready: {
        type: Boolean,
        value: false
      },
      project: {
        type: String,
        value: 'Swarm City'
      },
      short: {
        type: String,
        value: 'SWT'
      },
      selectedpage: {
        type: Number,
        value: 0
      },
      ethbalance: {
        type: Number,
        value: 0
      },
      tokenbalance: {
        type: Number,
        value: 0
      },
      currentprice: {
        type: Number,
        value: 0
      },
      erc20: {
        type: String
      },
      privatekey: {
        type: String,
        value: 'a15819f2962ee88d45053be156f37a2678693f4cf59b2b88bcd3da832bc87d3c',
        observer: 'makeReady'
      },
      fillingbalance: {
        type: Number,
        value: 0
      },
      swtamount: {
        type: Number,
        value: 0.00
      },
      gasstation: {
        type: Object,
        value: {}
      },
      minimetoken: {
        type: Object,
        value: {}
      },
      apiendpoint: {
        type: String,
      },
      ethnode: {
        type: String
      }
    };
  }

  toStation() {
    console.log('to station');
    this.selectedpage = 1;
  }

  toPersonalizedoffer() {


    var self = this;

    self.selectedpage = 2;

    var data = {
      take: this.weineeded,
      from : this.address,
      tokenaddress: this.erc20,
    };

    // send the TX to the backend
    var xhr = new XMLHttpRequest();
    xhr.open("POST", self.apiendpoint + '/sign', true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function() {
      if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
        console.log(xhr);
        const json = JSON.parse(xhr.responseText);

        self.signresult = json;

        self.swtamount = json.give / 1e18; //self.signresult self.pricefor1 * self.nrofdeals;
        //self.swtamount = Math.floor(self.swtamount.toFixed(4));
        //self.swtdisplay = self.swtamount / 1e18;
        self.selectedpage = 2;
        self.weiamount = ((self.weineeded * self.nrofdeals) / 1e18).toFixed(4);
//debugger;
      }
    }
    xhr.send(JSON.stringify(data));

  }

  toEnd() {
    this.selectedpage = 4;
  }

  exitStation() {
    this.selectedpage = 0;
  }

  doSomething() {
    var x = this.selecteditem.getAttribute("name");
    console.log('something was selected, ', x);
    this.nrofdeals = x;
  }

  _close() {
    alert('In Swarm City, this close icon would take you back');
  }

  getPrice() {

    return new Promise((resolve, reject) => {
      // Load the translations.json file
      const xobj = new XMLHttpRequest();
      xobj.overrideMimeType('application/json');
      // Ask sponnet api for the price:
      // From, To and Amount, Token(ERC20) you want to send
      // sponnet will send back the signed personalized offer
      // I get back: price, personal offer, validity,
      // POST: params anders meegeven
      xobj.open('POST', this.apiendpoint + '/offer?from=' + this.address+'&tokenaddress=' + this.erc20, true);
      xobj.onreadystatechange = () => {
        if (xobj.readyState == 4 && xobj.status == '200') {
          // Parse the response
          const json = JSON.parse(xobj.responseText);
          this.getPriceResult = json;
          this.getPriceResult_pre = JSON.stringify(json, null, 2);
          // this.currentprice = wei for 1 swt
          // this.currentprice = this.getPriceResult.price;
          //
          // this.gasPrice = this.getPriceResult.gasprice;
          //
          // this.weineeded = 117000 * this.gasPrice;
          //
          // this.amountswtpertx = Math.ceil(this.weineeded * 1e18 / this.currentprice);
          //
          // //this.swtneeded = this.weineeded / this.currentprice;
          // this.pricefor1 = this.amountswtpertx / 1e18;
          // this.pricefor10 = this.amountswtpertx * 10 / 1e18;
          // this.pricefor20 = this.amountswtpertx * 20 / 1e18;
          // this.pricefor50 = this.amountswtpertx * 50 / 1e18;
          // this.pricefor100 = this.amountswtpertx * 100 / 1e18;

          this.showfill = true;
          resolve();
        }
      };
      xobj.send(null);
    });
  }

  formatbalance(b){
    if (!b || b <= 0) return 0;
    return(b.toFixed(4));
  }

  getBalances() {
    // Get the current SWT and ETH balances
    var self = this;
    var minime = this.web3.eth.contract(this.minimetoken.abi);
    var minimeInstance = minime.at(this.erc20);
    minimeInstance.balanceOf(this.address, function(err, res) {
      if (!err) {
        console.log('SWT balance of client\'s account (',self.address,') is', res.toFormat(2));
        var tokenshit = res / 1e18;
        self.tokenbalance = tokenshit.toFixed(4);

        self.web3.eth.getBalance(self.address, function(err, res) {
          console.log('ETH balance of client\'s account (',self.address,') is', res.toString(10));
          self.ethbalance = (res/ 1e18).toFixed(4);
        });
        //self.gasstationready = true;
      }
    });
  }

  showbalances() {
    var self = this;
    // animation to open up the balances view and check the current balance.
    setTimeout(function() {
      //your code to be executed after 1 second
      self.shadowRoot.querySelector('#balancesview').hidden = false;
    }, 1000);
  }

  fillUp() {

    this.selectedpage = 3;
    var audio = new Audio('../images/done.m4a');
    //this.swtamount = 1.00;
    var amounttoget = this.swtamount / 1e18;

    var self = this;
    var now = 0;

    var x = setInterval(function() {
      now = now + 0.0001;
      //audio.play();
      self.fillingbalance = now.toFixed(4);

      // If the count down is finished, write some text
      if (now >= amounttoget) {
        //audio.play();
        clearInterval(x);
        self.fillingbalance = self.swtdisplay;
        self.showbalances();
      }
    }, 5);



    var minime = this.web3.eth.contract(this.minimetoken.abi);
    var minimeInstance = minime.at(this.signresult.token_address);

    // minimeInstance.balanceOf(this.address, function(err, res) {
    //   console.log('SWT balance is', res.toFormat(2));
    //   self.tokenbalance = res;
    // });

    console.log('sending approval for ', this.signresult.give , 'to', this.signresult.to);

    var txData = minimeInstance.approve.getData(this.signresult.to, this.signresult.give);

    this.web3.eth.estimateGas({
      to: this.signresult.to,
      data: txData,
      from: self.address
    }, function(err, res) {
      if (err) {
        console.log(err);
      }
      console.log('gas required=',res,typeof res);
      var gasRequired = res;

      // get nonce
      self.web3.eth.getTransactionCount(self.address, function(err, nonce) {

        if (!nonce) {
          console.log('nonce of address', self.address, 'is undefined...');
          nonce = 0;
        }

        console.log('nonce of address', self.address, 'is', nonce);

        var txParams = {
          nonce: nonce++,
          gasPrice: self.gasPrice,
          gasLimit: gasRequired + 50000,
          to: self.signresult.token_address,
          from: self.address,
          data: txData,
          chainId: 1
        };

        console.log('TX1 params' , txParams);

        var tx = new EthJS.Tx(txParams);
        tx.sign(self.privatekey_buffer);
        var serializedTx = tx.serialize(); //.toString('hex');

        var tx1 = EthJS.Util.addHexPrefix(serializedTx.toString('hex'));

        console.log('tx1');
        console.log(txParams);
        console.log(tx1);

        var gasstation = self.web3.eth.contract(self.gasstation.abi);
        self.gasstationInstance = gasstation.at(self.signresult.to);


    minimeInstance.balanceOf(self.address, function(err, res) {
      var pong = res/1e18;
      console.log('my SWT balance is', pong.toFixed(18));
      //var tospend = self.swtamount * self.signresult.price;
      console.log('I will send ', self.signresult.give, ' SWT units to receive ' , self.signresult.take , ' ETH units');
    });

        txData = self.gasstationInstance.fillup.getData(
          self.signresult.token_address,
          self.signresult.valid_until,
          self.signresult.random,
          self.signresult.take,
          self.signresult.give,
          self.signresult.sig.v,
          self.signresult.sig.r,
          self.signresult.sig.s);
//debugger;
        txParams = {
          nonce: nonce++,
          gasPrice: self.gasPrice,
          gasLimit: 200000,
          from: self.address,
          to: self.signresult.to,
          data: txData,
          chainId: 1
        };

        var tx2 = new ethereumjs.Tx(txParams);
        tx2.sign(self.privatekey_buffer);
        serializedTx = tx2.serialize();

        var tx2 = ethereumjs.Util.addHexPrefix(serializedTx.toString('hex'));

        console.log('tx2');
        console.log(txParams);
        console.log(tx2);

        var res = {
          tx1: tx1,
          tx2: tx2
        };

        // send the TX to the backend
        var xhr = new XMLHttpRequest();
        xhr.open("POST", self.apiendpoint + '/fillup', true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.onreadystatechange = function() {
          if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
            console.log(xhr);
          }
        }
        xhr.send(JSON.stringify(res));


      });
    });


  }

  gettankbalance() {
    var minime = this.web3.eth.contract(this.minimetoken.abi);
    var minimeInstance = minime.at(this.erc20);
    var self = this;
    minimeInstance.balanceOf(this.getPriceResult.to, function(err, res) {
      if (!err) {
        console.log('GT balance at '+self.getPriceResult.to+'is', res.toFormat(2));
        //self.tokenbalance = res;
      }
    });
  }

  ready() {
    super.ready();
  }

  makeReady() {

        var self = this;

        this.web3 = new Web3(new Web3.providers.HttpProvider(this.ethnode));

        let gasstationlib = webpack.gasstationlib({
          currentProvider: this.web3.currentProvider
        });

        let privateKey = '12ed1823ef1c2702b69d44aae3e4beeab8ac3b3d8668e41edbc42e871f1933b2';

        // example getting pubkey from private key
        let pubKey = gasstationlib.privateToAddress(privateKey);

        // SWT token address
        let tokenAddress = "0xb9e7f8568e08d5659f5d29c4997173d84cdf2607";

        // the gasstation (this is a dummy address)
        let gasStationAddress = "0xb015d1120b9c6333f6a9f38646309beb266b3943";

        // now query the price from the API ( TODO )
        // with the paremeter :
        // 1. I need 1000000000 gas
        // 2. This is the Token I want to give ( ticker : 'swarm-city')
        // 3. This is the address where to receive the gas (and where tokens are)
        // the API will return these parameters :
        let _tokensGive = 1 // amount of tokens i need to give
        let _gasOffer = 1000000000 // amount of gas you will get in return
        let _validUntil = 5000000 // this offer is valid until this block nr.



        // client signs off on these parameters
        let clientSig = gasstationlib.signGastankParameters(
          tokenAddress,
          gasStationAddress,
          1,  // tokens to give
          _gasOffer,
          _validUntil,
          privateKey);
        console.log('------Client Signature-----');
        console.log(clientSig);
        console.log('-----/Client Signature-----');

        gasstationlib.getapprovaltx(
          pubKey,
          privateKey,
          tokenAddress,
          1,    // approval for how many SWT units ?
          gasStationAddress
        ).then((approvalTx) => {
          console.log('------Approval Signature-----');
          console.log('approvalTx=', approvalTx);
          console.log('-----/Approval Signature-----');



          // now you need to send off these 2 things back to the API:
          let gasOrderConfirmation = {
            approval: approvalTx,
            clientsig: clientSig,
          };

          // POST /gasorder
          // + gasOrderConfirmation
          console.log('------Send this to API -----');
          console.log(gasOrderConfirmation);
          console.log('-----/Send this to API -----');

          // and now the API will do its thing... just wait for the 
          // gas to appear...


        });




        //var gsLib = require('gasstationlib');

        // this.tokenamount = 1;
        // this.gasPrice = 2 * 1e9; // 2 GWei

        //this.address = ethereumjs.Util.addHexPrefix(ethereumjs.Util.privateToAddress(ethereumjs.Util.addHexPrefix(this.privatekey)).toString('hex'));

        //this.privatekey_buffer = new ethereumjs.Buffer.Buffer(this.privatekey, "hex");

      //   // Get the minime and token abi
      //   var minimetokenabi;
      //   var gassstationabi;

      //   self.getPrice().then(function(){

      //   //self.erc20 = "0xd2444365f33079be7160b7052cf544594c137e3d";

      //   // Get abis
      //   return new Promise((resolve, reject) => {
      //     // Load the translations.json file
      //     const xobj = new XMLHttpRequest();
      //     xobj.overrideMimeType('application/json');
      //     xobj.open('GET', self.apiendpoint + '/abi', true);
      //     xobj.onreadystatechange = () => {
      //       if (xobj.readyState == 4 && xobj.status == '200') {
      //         // Parse the response
      //         const json = JSON.parse(xobj.responseText);
      //         console.log(json);
      //         //return json;
      //         self.minimetoken.abi = json.erc20;
      //         self.gasstation.abi = json.gasstation;
      //         var minime = self.web3.eth.contract(json.erc20);
      //         var minimeInstance = minime.at(self.erc20);
      //         minimeInstance.balanceOf(self.address, function(err, res) {
      //           if (!err) {
      //             console.log('SWT balance of client\'s account (',self.address,') is', res.toFormat(2));
      //             var tokenshit = res / 1e18;
      //             self.tokenbalance = tokenshit.toFixed(2);

      //             self.web3.eth.getBalance(self.address, function(err, res) {
      //               console.log('ETH balance of client\'s account (',self.address,') is', res.toString(10));
      //               self.ethbalance = (res/ 1e18).toFixed(2);
      //             });
      //             self.gasstationready = true;
      //           }
      //         });

      //         resolve();
      //       }
      //     };
      //     xobj.send(null);
      //   });

      // });

        // End getting minime and token abi

  }
}

window.customElements.define(ScGasstationclient.is, ScGasstationclient);
</script>
</dom-module>
